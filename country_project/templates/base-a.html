{% extends "base.html" %}

{% block title %}Register{% endblock %}

{% block content %}
<div class="jumbotron">
    <h2>Please Register</h2>
    <form method="post" data-aos="fade-up" data-aos-duration="3000">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.first_name.label(class="form-label") }}
            {{ form.first_name(class="form-control") }}
            {% for error in form.first_name.errors %}
            <small class="form-text text-danger">{{ error }}</small>
            {% endfor %}
        </div>
        <div class="form-group">
            {{ form.last_name.label(class="form-label") }}
            {{ form.last_name(class="form-control") }}
            {% for error in form.last_name.errors %}
            <small class="form-text text-danger">{{ error }}</small>
            {% endfor %}
        </div>
        <div class="form-group">
            {{ form.country.label(class="form-label") }}
            {{ form.country(class="form-control") }}
            {% for error in form.country.errors %}
            <small class="form-text text-danger">{{ error }}</small>
            {% endfor %}
        </div>
        
        <div class="form-group">
            {{ form.state.label(class="form-label") }}
            {{ form.state(class="form-control") }}
            {% for error in form.state.errors %}
            <small class="form-text text-danger">{{ error }}</small>
            {% endfor %}
        </div>
        <div class="form-group">
            {{ form.local_government.label(class="form-label") }}
            {{ form.local_government(class="form-control") }}
            {% for error in form.local_government.errors %}
            <small class="form-text text-danger">{{ error }}</small>
            {% endfor %}
        </div>
        <div class="form-group">
            {{ form.phone_number.label(class="form-label") }}
            {{ form.phone_number(class="form-control", id="phone") }}
            {% for error in form.phone_number.errors %}
            <small class="form-text text-danger">{{ error }}</small>
            {% endfor %}
        </div>
        <div>
            {{ form.picture.label }}<br>
            {{ form.picture() }}<br>
            {% for error in form.picture.errors %}
                <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </div>
        <br>
        <div>
            {{ form.id_document.label }}<br>
            {{ form.id_document() }}<br>
            {% for error in form.id_document.errors %}
                <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </div>
        <br>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
        
        
        <div>
            <a href="{{ url_for('users.login') }}" class="link-arrow">Already have an account?</a>
        </div>
    </form>
</div>

<script>
    $(document).ready(function() {
        $('#country').change(function() {
            var country_code = $(this).val();
            $.ajax({
                url: '/get_states',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({country_code: country_code}),
                success: function(response) {
                    var state_select = $('#state');
                    state_select.empty();
                    $.each(response, function(index, state) {
                        state_select.append($('<option>', { 
                            value: state[0],
                            text : state[1] 
                        }));
                    });
                }
            });
        });
    });
</script>

<script>
    var input = document.querySelector("#phone");
    window.intlTelInput(input, {
        initialCountry: "auto",
        geoIpLookup: function(success, failure) {
            fetch('https://ipinfo.io?token=your_token')
                .then(function(resp) { return resp.json(); })
                .then(function(resp) { success(resp.country); })
                .catch(function() { success("us"); });
        },
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });

    // Fetch states and local governments
    $.ajax({
        url: '/api/nigeria',
        method: 'GET',
        success: function(data) {
            let stateSelect = $('#state');
            let localGovSelect = $('#local_government');

            // Populate state select field
            stateSelect.empty();
            localGovSelect.empty();
            stateSelect.append('<option value="">Select State</option>');
            localGovSelect.append('<option value="">Select Local Government</option>');

            $.each(data, function(state, localGovernments) {
                stateSelect.append('<option value="' + state + '">' + state + '</option>');
            });

            // Update local governments when a state is selected
            stateSelect.change(function() {
                let selectedState = $(this).val();
                localGovSelect.empty();
                localGovSelect.append('<option value="">Select Local Government</option>');

                if (selectedState) {
                    let localGovernments = data[selectedState];
                    $.each(localGovernments, function(index, localGovernment) {
                        localGovSelect.append('<option value="' + localGovernment + '">' + localGovernment + '</option>');
                    });
                }
            });
        },
        error: function() {
            alert('Failed to fetch data from the API.');
        }
    });

    // Auto-detect country and state using geolocation API
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                .then(response => response.json())
                .then(data => {
                    const country = data.address.country_code.toUpperCase();
                    const state = data.address.state;

                    if (country) {
                        $('#country').val(country).change();
                    }
                    if (state) {
                        $('#state').val(state).change();
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    } else {
        console.error('Geolocation is not supported by this browser.');
    }
</script>
<script>
    var input = document.querySelector("#phone");
    var iti = window.intlTelInput(input, {
        initialCountry: "auto",
        geoIpLookup: function(success, failure) {
            fetch('https://ipinfo.io?token=your_token')
                .then(function(resp) { return resp.json(); })
                .then(function(resp) { success(resp.country); })
                .catch(function() { success("us"); });
        },
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    });

    // Before form submission, set the input value to the full international number
    $("form").submit(function() {
        input.value = iti.getNumber();
    });
</script>

{% endblock %}